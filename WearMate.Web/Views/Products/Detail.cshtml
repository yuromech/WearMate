@model WearMate.Web.Models.ViewModels.ProductDetailViewModel
@{
    ViewData["Title"] = Model.Product.Name;
    var product = Model.Product;
    var metaDescription = string.IsNullOrWhiteSpace(product.ShortDescription) ? (product.Description ?? product.Name) : product.ShortDescription;
}

@section HeadContent {
    <meta name="description" content="@metaDescription" />
    <meta property="og:title" content="@product.Name" />
    <meta property="og:description" content="@metaDescription" />
    <meta property="og:image" content="@(Model.Images.FirstOrDefault()?.ImageUrl ?? product.ThumbnailUrl ?? "/images/product-placeholder.png")" />
}

<div class="container py-5" x-data="productDetail()" x-init="init()">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0 m-0 small text-uppercase tracking-wide">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" class="text-decoration-none text-muted">Trang chủ</a></li>
            @if (product.Category != null)
            {
                <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index" asp-route-categoryId="@product.Category.Id" class="text-decoration-none text-muted">@product.Category.Name</a></li>
            }
            <li class="breadcrumb-item active fw-bold text-dark" aria-current="page">@product.Name</li>
        </ol>
    </nav>

    <div class="row g-5">
        <!-- Left: Gallery -->
        <div class="col-lg-7">
            <div class="position-relative mb-3 rounded-4 overflow-hidden bg-white shadow-sm" style="aspect-ratio: 4/5;">
                <img :src="selectedImage" class="w-100 h-100 object-fit-contain" />
                
                @if (product.SalePrice.HasValue)
                {
                    <span class="position-absolute top-0 start-0 m-3 badge bg-danger rounded-pill px-3 py-2">-@((int)((1 - product.SalePrice / product.BasePrice) * 100))%</span>
                }
            </div>

            <div class="d-flex gap-2 overflow-auto pb-2" style="scrollbar-width: thin;">
                <template x-for="img in images">
                    <div class="rounded-3 overflow-hidden border border-2" 
                         :class="{ 'border-primary': img === selectedImage, 'border-transparent': img !== selectedImage }" 
                         style="width: 80px; height: 80px; cursor: pointer; flex-shrink: 0;"
                         @@click="selectedImage = img">
                        <img :src="img" class="w-100 h-100 object-fit-cover" />
                    </div>
                </template>
            </div>
        </div>

        <!-- Right: Product Info -->
        <div class="col-lg-5">
            <div class="ps-lg-4">
                <div class="mb-2 text-uppercase text-accent fw-bold small tracking-wider" style="color: var(--accent);">
                    @product.Category?.Name
                </div>
                <h1 class="display-5 fw-bold mb-3" style="font-family: var(--font-heading);">@product.Name</h1>

                <div class="d-flex align-items-end gap-3 mb-4">
                    @if (product.SalePrice.HasValue)
                    {
                        <div class="display-6 fw-bold text-danger">@product.SalePrice.Value.ToString("N0")đ</div>
                        <div class="h4 text-muted text-decoration-line-through mb-2">@product.BasePrice.ToString("N0")đ</div>
                    }
                    else
                    {
                        <div class="display-6 fw-bold">@product.BasePrice.ToString("N0")đ</div>
                    }
                </div>

                <div class="mb-4">
                    <p class="text-muted lead" style="font-size: 1.1rem;">@Html.Raw(product.ShortDescription ?? "Sản phẩm chất lượng cao từ WearMate.")</p>
                </div>

                <hr class="my-4 opacity-10">

                <!-- Variant selectors -->
                <div class="mb-4">
                    @if (Model.Variants != null && Model.Variants.Any())
                    {
                        @if (Model.Variants.Any(v => !string.IsNullOrEmpty(v.Color)))
                        {
                            <div class="mb-4">
                                <label class="fw-bold mb-2 d-block">Màu sắc: <span class="fw-normal" x-text="selectedColor || 'Chọn màu'"></span></label>
                                <div class="d-flex gap-2 flex-wrap">
                                    @foreach (var color in Model.Variants.Where(v => !string.IsNullOrWhiteSpace(v.Color)).Select(v => v.Color).Distinct())
                                    {
                                        <button type="button" 
                                                class="btn btn-outline-dark rounded-pill px-3" 
                                                :class="{ 'btn-dark text-white': selectedColor === '@color', 'btn-outline-dark': selectedColor !== '@color' }" 
                                                @@click="selectColor('@color')">
                                            @color
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        @if (Model.Variants.Any(v => !string.IsNullOrEmpty(v.Size)))
                        {
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="fw-bold">Kích thước: <span class="fw-normal" x-text="selectedSize || 'Chọn size'"></span></label>
                                    <a href="#" class="text-muted small text-decoration-underline">Hướng dẫn chọn size</a>
                                </div>
                                <div class="d-flex gap-2 flex-wrap">
                                    @foreach (var size in Model.Variants.Where(v => !string.IsNullOrWhiteSpace(v.Size)).Select(v => v.Size).Distinct())
                                    {
                                        <button type="button" 
                                                class="btn btn-outline-dark" 
                                                style="min-width: 48px; height: 48px;"
                                                :class="{ 'btn-dark text-white': selectedSize === '@size', 'btn-outline-dark': selectedSize !== '@size' }" 
                                                @@click="selectSize('@size')">
                                            @size
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Add to Cart -->
                <div class="d-flex gap-3 mb-4">
                    <div class="input-group" style="width: 140px;">
                        <button class="btn btn-outline-secondary border-end-0" @@click="decreaseQty"><i class="bi bi-dash"></i></button>
                        <input type="text" class="form-control text-center border-start-0 border-end-0 bg-transparent" x-model="qty" readonly />
                        <button class="btn btn-outline-secondary border-start-0" @@click="increaseQty"><i class="bi bi-plus"></i></button>
                    </div>
                    <button class="btn btn-primary flex-grow-1 rounded-pill py-3 fw-bold shadow-sm" 
                            @@click="addToCart()" 
                            :disabled="!selectedVariant || !selectedVariant.isActive || !productIsActive">
                        <i class="bi bi-bag-plus me-2"></i> Thêm vào giỏ hàng
                    </button>
                </div>

                <!-- Trust Badges -->
                <div class="row g-3 text-muted small mt-2">
                    <div class="col-6 d-flex align-items-center gap-2">
                        <i class="bi bi-truck fs-5"></i> Miễn phí vận chuyển
                    </div>
                    <div class="col-6 d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-repeat fs-5"></i> Đổi trả trong 30 ngày
                    </div>
                    <div class="col-6 d-flex align-items-center gap-2">
                        <i class="bi bi-shield-check fs-5"></i> Bảo hành chính hãng
                    </div>
                    <div class="col-6 d-flex align-items-center gap-2">
                        <i class="bi bi-check-circle fs-5"></i> Kiểm tra hàng trước khi nhận
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Tabs -->
    <div class="mt-5 pt-5">
        <ul class="nav nav-tabs nav-fill mb-4 border-bottom-0" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold border-0 border-bottom border-2 rounded-0" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab">Mô tả sản phẩm</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold border-0 border-bottom border-2 rounded-0" id="spec-tab" data-bs-toggle="tab" data-bs-target="#spec" type="button" role="tab">Thông số kỹ thuật</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold border-0 border-bottom border-2 rounded-0" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab">Đánh giá</button>
            </li>
        </ul>
        <div class="tab-content bg-white p-5 rounded-4 shadow-sm" id="productTabsContent">
            <div class="tab-pane fade show active" id="desc" role="tabpanel">
                <div class="prose" style="max-width: 800px; margin: 0 auto;">
                    @Html.Raw(product.Description ?? "Chưa có mô tả chi tiết cho sản phẩm này.")
                </div>
            </div>
            <div class="tab-pane fade" id="spec" role="tabpanel">
                <table class="table table-borderless" style="max-width: 600px; margin: 0 auto;">
                    <tbody>
                        <tr>
                            <td class="text-muted w-50">Mã sản phẩm</td>
                            <td class="fw-medium">@product.Sku</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Thương hiệu</td>
                            <td class="fw-medium">@(product.Brand?.Name ?? "N/A")</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Danh mục</td>
                            <td class="fw-medium">@(product.Category?.Name ?? "N/A")</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="review" role="tabpanel">
                <div class="text-center py-5">
                    <i class="bi bi-chat-square-text fs-1 text-muted mb-3 d-block"></i>
                    <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
                    <button class="btn btn-outline-primary rounded-pill">Viết đánh giá</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Related products -->
    @if (Model.RelatedProducts.Any())
    {
        <div class="mt-5 pt-5 border-top">
            <h3 class="fw-bold mb-4 text-center">Có thể bạn cũng thích</h3>
            <div class="row g-4">
                @foreach (var p in Model.RelatedProducts.Take(4))
                {
                    <div class="col-lg-3 col-md-4 col-6">
                        <div class="card product-card h-100">
                            <div class="product-img-wrapper">
                                <img src="@(p.ThumbnailUrl ?? "/images/product-placeholder.png")" alt="@p.Name">
                                <div class="product-actions">
                                    <a asp-controller="Products" asp-action="Detail" asp-route-slug="@p.Slug" class="action-btn" title="Xem chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body text-center">
                                <div class="text-muted small mb-1">@p.Category?.Name</div>
                                <h6 class="fw-bold text-truncate mb-2"><a asp-controller="Products" asp-action="Detail" asp-route-slug="@p.Slug" class="text-dark text-decoration-none">@p.Name</a></h6>
                                <div class="fw-bold">@(p.SalePrice.HasValue ? p.SalePrice.Value.ToString("N0") : p.BasePrice.ToString("N0"))đ</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

</div>

<!-- Alpine.js logic -->
<script>
    function productDetail() {
        return {
            qty: 1,
            images: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Images.Select(i => i.ImageUrl))),
            selectedImage: "",
            selectedColor: null,
            selectedSize: null,
            selectedVariant: null,
            productIsActive: @((Model.Product.IsActive) ? "true" : "false"),
            variants: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Variants)),

            init() {
                this.selectedImage = this.images.length > 0 ? this.images[0] : ("@(Model.Product.ThumbnailUrl ?? "/images/product-placeholder.png")");
                // preselect if single variant
                if (this.variants.length === 1) {
                    this.selectedVariant = this.variants[0];
                    if(this.selectedVariant.color) this.selectedColor = this.selectedVariant.color;
                    if(this.selectedVariant.size) this.selectedSize = this.selectedVariant.size;
                }
            },

            selectColor(color) {
                this.selectedColor = color;
                this.updateVariant();
            },

            selectSize(size) {
                this.selectedSize = size;
                this.updateVariant();
            },

            increaseQty() { this.qty++; },
            decreaseQty() { if (this.qty > 1) this.qty--; },

            updateVariant() {
                if (!this.variants || this.variants.length === 0) return;
                this.selectedVariant = this.variants.find(v =>
                    (this.selectedColor ? (v.color && v.color.toLowerCase() === this.selectedColor.toLowerCase()) : true)
                    && (this.selectedSize ? (v.size && v.size.toLowerCase() === this.selectedSize.toLowerCase()) : true)
                );
            },

            addToCart() {
                if (!this.productIsActive) { alert('Sản phẩm hiện đang tạm ẩn'); return; }
                if (!this.selectedVariant) { alert('Vui lòng chọn đầy đủ tùy chọn (Màu sắc, Kích thước)'); return; }

                // Basic feedback — integrate real cart API as needed
                fetch('/Cart/Add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productVariantId: this.selectedVariant.id, quantity: this.qty })
                }).then(r => {
                    if (r.ok) { 
                        // Show toast or alert
                        const toast = document.createElement('div');
                        toast.className = 'position-fixed bottom-0 end-0 p-3';
                        toast.style.zIndex = '1100';
                        toast.innerHTML = `
                            <div class="toast show align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="d-flex">
                                    <div class="toast-body">
                                        <i class="bi bi-check-circle me-2"></i> Đã thêm vào giỏ hàng thành công!
                                    </div>
                                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                        
                        // Update cart count if possible (reload for now)
                        setTimeout(() => location.reload(), 1000);
                    }
                    else alert('Không thể thêm vào giỏ hàng');
                }).catch(e => alert('Lỗi: ' + e.message));
            }
        }
    }
</script>

@* Structured data JSON-LD (server-serialized to avoid Razor @ parsing) *@
@{
    var ld = new Dictionary<string, object?>();
    ld["@context"] = "https://schema.org/";
    ld["@type"] = "Product";
    ld["name"] = Model.Product.Name;
    ld["image"] = Model.Images.Select(i => i.ImageUrl).ToArray();
    ld["description"] = metaDescription;
    ld["sku"] = Model.Product.Sku;
    ld["offers"] = new Dictionary<string, object?>
    {
        ["@type"] = "Offer",
        ["priceCurrency"] = "VND",
        ["price"] = (Model.Product.SalePrice ?? Model.Product.BasePrice).ToString(),
        ["availability"] = (Model.Product.IsActive) ? "https://schema.org/InStock" : "https://schema.org/OutOfStock"
    };
    var jsonLd = System.Text.Json.JsonSerializer.Serialize(ld);
}
<script type="application/ld+json">@Html.Raw(jsonLd)</script>
