@model WearMate.Web.Models.ViewModels.ProductListViewModel
@using WearMate.Shared.Helpers

@{
    ViewData["Title"] = "Sản phẩm";
}

<div class="container py-5">

    <!-- Mobile Filter Toggle -->
    <button class="btn btn-outline-dark d-md-none mb-4 w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterSidebar">
        <i class="bi bi-funnel me-2"></i> Bộ lọc sản phẩm
    </button>

    <div class="row g-5">

        <!-- ============================================================
             FILTER SIDEBAR
        ============================================================ -->
        <div class="col-md-3">
            <div class="offcanvas-md offcanvas-start" tabindex="-1" id="filterSidebar">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title fw-bold">Bộ lọc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#filterSidebar"></button>
                </div>
                <div class="offcanvas-body d-block">
                    
                    <!-- Search -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3 text-uppercase small tracking-wide">Tìm kiếm</h6>
                        <form method="get" action="/Products" class="position-relative">
                            <input type="text"
                                   name="search"
                                   class="form-control rounded-pill ps-4"
                                   placeholder="Tìm sản phẩm..."
                                   value="@Model.SearchQuery" />
                            <button class="btn position-absolute top-50 end-0 translate-middle-y border-0 bg-transparent pe-3" type="submit">
                                <i class="bi bi-search text-muted"></i>
                            </button>
                            
                            <!-- Preserve other filters (only if they have values) -->
                            @if (!string.IsNullOrEmpty(Model.SelectedCategory))
                            {
                                <input type="hidden" name="category" value="@Model.SelectedCategory" />
                            }
                            @if (!string.IsNullOrEmpty(Model.SelectedBrand))
                            {
                                <input type="hidden" name="brand" value="@Model.SelectedBrand" />
                            }
                            @if (!string.IsNullOrEmpty(Model.Sort))
                            {
                                <input type="hidden" name="sort" value="@Model.Sort" />
                            }
                        </form>
                    </div>

                    <!-- Categories -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3 text-uppercase small tracking-wide">Danh mục</h6>
                        <div class="d-flex flex-column gap-2">
                            @{
                                var allCatUrl = "/Products";
                                if (!string.IsNullOrEmpty(Model.SearchQuery)) allCatUrl += $"?search={Model.SearchQuery}";
                                if (!string.IsNullOrEmpty(Model.SelectedBrand)) allCatUrl += (allCatUrl.Contains("?") ? "&" : "?") + $"brand={Model.SelectedBrand}";
                                if (!string.IsNullOrEmpty(Model.Sort)) allCatUrl += (allCatUrl.Contains("?") ? "&" : "?") + $"sort={Model.Sort}";
                            }
                            <a href="@allCatUrl"
                               class="text-decoration-none d-flex justify-content-between align-items-center py-1 @(string.IsNullOrEmpty(Model.SelectedCategory) ? "fw-bold text-dark" : "text-muted")">
                                <span>Tất cả</span>
                                @if(string.IsNullOrEmpty(Model.SelectedCategory)) { <i class="bi bi-check-lg text-primary"></i> }
                            </a>

                            @foreach (var c in Model.Categories)
                            {
                                var catUrl = $"/Products?category={c.Slug}";
                                if (!string.IsNullOrEmpty(Model.SearchQuery)) catUrl += $"&search={Model.SearchQuery}";
                                if (!string.IsNullOrEmpty(Model.SelectedBrand)) catUrl += $"&brand={Model.SelectedBrand}";
                                if (!string.IsNullOrEmpty(Model.Sort)) catUrl += $"&sort={Model.Sort}";
                                
                                <a href="@catUrl"
                                   class="text-decoration-none d-flex justify-content-between align-items-center py-1 @(Model.SelectedCategory == c.Slug ? "fw-bold text-dark" : "text-muted")">
                                    <span>@c.Name</span>
                                    @if(Model.SelectedCategory == c.Slug) { <i class="bi bi-check-lg text-primary"></i> }
                                </a>
                            }
                        </div>
                    </div>

                    <!-- Brand Filter -->
                    @if (Model.Brands.Any())
                    {
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3 text-uppercase small tracking-wide">Thương hiệu</h6>
                            <div class="d-flex flex-column gap-2">
                                @foreach (var b in Model.Brands)
                                {
                                    var brandUrl = $"/Products?brand={b.Slug}";
                                    if (!string.IsNullOrEmpty(Model.SelectedCategory)) brandUrl += $"&category={Model.SelectedCategory}";
                                    if (!string.IsNullOrEmpty(Model.SearchQuery)) brandUrl += $"&search={Model.SearchQuery}";
                                    if (!string.IsNullOrEmpty(Model.Sort)) brandUrl += $"&sort={Model.Sort}";
                                    
                                    <a href="@brandUrl"
                                       class="text-decoration-none d-flex justify-content-between align-items-center py-1 @(Model.SelectedBrand == b.Slug ? "fw-bold text-dark" : "text-muted")">
                                        <span>@b.Name</span>
                                        @if(Model.SelectedBrand == b.Slug) { <i class="bi bi-check-lg text-primary"></i> }
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- ============================================================
             PRODUCT LIST
        ============================================================ -->
        <div class="col-md-9">

            <!-- Title + Sort -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-0" style="font-family: var(--font-heading);">
                        @(!string.IsNullOrEmpty(Model.SelectedCategory) ? Model.Categories.FirstOrDefault(c => c.Slug == Model.SelectedCategory)?.Name : "Tất cả sản phẩm")
                    </h2>
                    <small class="text-muted">Hiển thị @Model.Products.Count() kết quả</small>
                </div>

                <form method="get" action="/Products" class="d-flex align-items-center">
                    <label class="me-2 text-muted small d-none d-md-block">Sắp xếp:</label>
                    <select name="sort"
                            class="form-select form-select-sm border-0 bg-light rounded-pill px-3 py-2"
                            style="width: auto; cursor: pointer;"
                            onchange="this.form.submit()">
                        <option value="">Mặc định</option>
                        <option value="price_asc" selected="@(Model.Sort == "price_asc")">Giá tăng dần</option>
                        <option value="price_desc" selected="@(Model.Sort == "price_desc")">Giá giảm dần</option>
                        <option value="newest" selected="@(Model.Sort == "newest")">Mới nhất</option>
                    </select>

                    <!-- Preserve state (only if values exist) -->
                    @if (!string.IsNullOrEmpty(Model.SearchQuery))
                    {
                        <input type="hidden" name="search" value="@Model.SearchQuery" />
                    }
                    @if (!string.IsNullOrEmpty(Model.SelectedCategory))
                    {
                        <input type="hidden" name="category" value="@Model.SelectedCategory" />
                    }
                    @if (!string.IsNullOrEmpty(Model.SelectedBrand))
                    {
                        <input type="hidden" name="brand" value="@Model.SelectedBrand" />
                    }
                </form>
            </div>


            <!-- ============================================================
                 Product Grid
            ============================================================ -->
            @if (Model.Products.Any())
            {
                <div class="row g-4 mb-5">
                    @foreach (var p in Model.Products)
                    {
                        <div class="col-lg-4 col-6">
                            <div class="card product-card h-100">
                                <div class="product-img-wrapper">
                                    <img src="@ImageHelper.GetProductImage(p.ThumbnailUrl)" alt="@p.Name">
                                    <div class="product-actions">
                                        <a asp-action="Detail" asp-route-slug="@p.Slug" class="action-btn" title="Xem chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button class="action-btn" title="Thêm vào giỏ">
                                            <i class="bi bi-bag-plus"></i>
                                        </button>
                                    </div>
                                    @if (p.SalePrice.HasValue)
                                    {
                                        <span class="position-absolute top-0 start-0 m-2 badge bg-danger rounded-pill">-@((int)((1 - p.SalePrice / p.BasePrice) * 100))%</span>
                                    }
                                </div>
                                <div class="card-body text-center">
                                    <div class="text-muted small mb-1">@p.Category?.Name</div>
                                    <h6 class="fw-bold text-truncate mb-2"><a asp-action="Detail" asp-route-slug="@p.Slug" class="text-dark text-decoration-none">@p.Name</a></h6>
                                    <div class="d-flex justify-content-center align-items-center gap-2">
                                        @if (p.SalePrice.HasValue)
                                        {
                                            <span class="text-muted text-decoration-line-through small">@p.BasePrice.ToString("N0")đ</span>
                                            <span class="text-danger fw-bold">@p.SalePrice.Value.ToString("N0")đ</span>
                                        }
                                        else
                                        {
                                            <span class="fw-bold">@p.BasePrice.ToString("N0")đ</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>


                <!-- ============================================================
                     Pagination
                ============================================================ -->
                @if (Model.TotalPages > 1)
                {
                    <nav>
                        <ul class="pagination justify-content-center gap-2">
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                var pageUrl = $"/Products?page={i}";
                                if (!string.IsNullOrEmpty(Model.SelectedCategory)) pageUrl += $"&category={Model.SelectedCategory}";
                                if (!string.IsNullOrEmpty(Model.SearchQuery)) pageUrl += $"&search={Model.SearchQuery}";
                                if (!string.IsNullOrEmpty(Model.SelectedBrand)) pageUrl += $"&brand={Model.SelectedBrand}";
                                if (!string.IsNullOrEmpty(Model.Sort)) pageUrl += $"&sort={Model.Sort}";
                                
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link rounded-circle d-flex align-items-center justify-content-center border-0 @(i == Model.CurrentPage ? "bg-dark text-white" : "bg-light text-dark")"
                                       style="width: 40px; height: 40px;"
                                       href="@pageUrl">
                                        @i
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <div class="mb-3 text-muted">
                        <i class="bi bi-search fs-1"></i>
                    </div>
                    <h5 class="fw-bold">Không tìm thấy sản phẩm nào</h5>
                    <p class="text-muted">Thử thay đổi bộ lọc hoặc tìm kiếm từ khóa khác.</p>
                    <a href="/Products" class="btn btn-outline-dark rounded-pill px-4">Xóa bộ lọc</a>
                </div>
            }

        </div>

    </div>
</div>
